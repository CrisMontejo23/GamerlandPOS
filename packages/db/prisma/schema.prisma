generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // si alguna vez usas pooling (pgbouncer) en DATABASE_URL, Prisma migrar√° por DIRECT_URL
  directUrl = env("DIRECT_URL") // opcional
}

model Product {
  id        Int              @id @default(autoincrement())
  sku       String           @unique
  barcode   String?          @unique
  name      String
  category  String?
  cost      Decimal          @db.Decimal(12, 2) @default(0)
  price     Decimal          @db.Decimal(12, 2) @default(0)
  taxRate   Decimal          @db.Decimal(5, 2)  @default(0)
  minStock  Int              @default(0)
  active    Boolean          @default(true)
  createdAt DateTime         @default(now())
  SaleItem  SaleItem[]
  StockMove StockMovement[]
  Layaway   Layaway[]

  @@index([sku])
  @@index([name])
  @@index([category])
}

model Sale {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id]) // ‚úÖ NUEVO
  storeId   Int?
  customer  String?
  subtotal  Decimal  @db.Decimal(12, 2) @default(0)
  tax       Decimal  @db.Decimal(12, 2) @default(0)
  discount  Decimal  @db.Decimal(12, 2) @default(0)
  total     Decimal  @db.Decimal(12, 2) @default(0)
  status    String   @default("paid")
  createdAt DateTime @default(now())
  items     SaleItem[]
  payments  Payment[]
  Layaway   Layaway[]
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  sale      Sale    @relation(fields: [saleId], references: [id])
  saleId    Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  qty       Int
  unitPrice Decimal @db.Decimal(12, 2) @default(0)
  taxRate   Decimal @db.Decimal(5, 2)  @default(0)
  discount  Decimal @db.Decimal(12, 2) @default(0)
  total     Decimal @db.Decimal(12, 2) @default(0)
}

model Payment {
  id        Int      @id @default(autoincrement())
  sale      Sale     @relation(fields: [saleId], references: [id])
  saleId    Int
  method    String   // EFECTIVO | QR_LLAVE | DATAFONO
  amount    Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  createdAt DateTime @default(now())
}

model StockMovement {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  type      String   // in|out|adj|return
  qty       Int
  unitCost  Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  userId    Int?
  storeId   Int?
  createdAt DateTime @default(now())

  @@index([productId, createdAt])
  @@index([type])
}

model Expense {
  id            Int      @id @default(autoincrement())
  storeId       Int?
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id]) // ‚úÖ NUEVO
  category      String
  description   String?
  amount        Decimal  @db.Decimal(12, 2) @default(0)
  paymentMethod String?
  createdAt     DateTime @default(now())

  @@index([createdAt])
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      Role     @default(EMPLOYEE)
  createdAt DateTime @default(now())

  sales     Sale[]    // ‚úÖ NUEVO (inversa)
  expenses  Expense[] // ‚úÖ NUEVO (inversa)
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum WorkStatus {
  RECEIVED     // Recibido
  IN_PROGRESS  // En proceso
  FINISHED     // Finalizado (listo para entrega)
  DELIVERED    // Entregado
}

enum WorkLocation {
  LOCAL
  BOGOTA
}

model WorkOrder {
  id            Int           @id @default(autoincrement())
  code          String                               // WK-00001
  item          String                               // qu√© se recibe
  description   String                               // descripci√≥n del caso
  customerName  String
  customerPhone String
  reviewPaid    Boolean       @default(false)        // pag√≥ $20.000 revisi√≥n
  status        WorkStatus    @default(RECEIVED)
  location      WorkLocation  @default(LOCAL)
  quote         Decimal?      @db.Decimal(12, 2)     // cotizaci√≥n (opcional)
  deposit       Decimal?      @db.Decimal(12, 2)     // acumulado de abonos (si decides mantenerlo)
  total         Decimal?      @db.Decimal(12, 2)     // total final (opcional)
  notes         String?                             // notas internas
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  payments      WorkOrderPayment[]                   // üëà inversa para pagos
  informedCustomer Boolean @default(false)

  isWarranty    Boolean   @default(false)
  parentId      Int?      // id del trabajo original (trazabilidad simple)

  items         WorkItem[]

  @@index([status, location, createdAt])
  @@index([code])
}

model WorkItem {
  id          Int        @id @default(autoincrement())
  workOrder   WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId Int

  label       String
  done        Boolean    @default(false)

  price       Decimal?   @db.Decimal(12, 2)   // valor del arreglo de ESTE producto
  detail      String?                          // descripci√≥n espec√≠fica del producto

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([workOrderId])
}

model WorkOrderPayment {
  id          Int        @id @default(autoincrement())
  workOrder   WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId Int
  amount      Decimal    @db.Decimal(12, 2)         // > 0 pago del cliente (abono o liquidaci√≥n)
  method      String?                                // CASH/CARD/NEQUI/etc
  note        String?
  createdAt   DateTime   @default(now())
  createdBy   String?                                // usuario que registr√≥

  @@index([workOrderId, createdAt])
}

enum LayawayStatus {
  OPEN   // ABIERTO
  CLOSED // CERRADO
}

model Layaway {
  id           Int            @id @default(autoincrement())
  code         String         @unique                 // AP-00001
  status       LayawayStatus  @default(OPEN)

  // Producto asociado al apartado (1 producto por sistema)
  product      Product        @relation(fields: [productId], references: [id])
  productId    Int

  // Snapshot de info del producto al abrir el apartado
  productName  String
  productPrice Decimal        @db.Decimal(12, 2)      // precio que se usa en el contrato

  // Datos del cliente
  customerName  String
  customerPhone String
  city          String?                               // ciudad de residencia (opcional)

  // Dinero
  initialDeposit Decimal      @db.Decimal(12, 2)      // abono inicial obligatorio
  totalPrice     Decimal      @db.Decimal(12, 2)      // valor objetivo a pagar (puede = productPrice)
  totalPaid      Decimal      @db.Decimal(12, 2) @default(0) // suma de todos los pagos (incluye inicial)

  // Fechas
  createdAt  DateTime     @default(now())            // fecha de apertura del sistema de apartado
  updatedAt  DateTime     @updatedAt
  closedAt   DateTime?                               // cuando se cierra (se complet√≥ o se cancel√≥)

  notes      String?                                 // notas internas si las necesitas

  // Relaci√≥n con abonos
  payments   LayawayPayment[]

  // Link opcional a la venta final en POS (cuando hagas FINALIZAR VENTA)
  saleId     Int?
  sale       Sale?         @relation(fields: [saleId], references: [id])

  @@index([status, createdAt])
  @@index([customerPhone])
}

model LayawayPayment {
  id         Int      @id @default(autoincrement())
  layaway    Layaway  @relation(fields: [layawayId], references: [id], onDelete: Cascade)
  layawayId  Int

  amount     Decimal  @db.Decimal(12, 2)             // valor del abono
  method     String                                  // EFECTIVO | QR_LLAVE | DATAFONO
  note       String?
  createdAt  DateTime @default(now())
  createdBy  String?                                  // usuario que registr√≥ el abono

  @@index([layawayId, createdAt])
}