generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // si alguna vez usas pooling (pgbouncer) en DATABASE_URL, Prisma migrarÃ¡ por DIRECT_URL
  directUrl = env("DIRECT_URL") // opcional
}

model Product {
  id        Int              @id @default(autoincrement())
  sku       String           @unique
  barcode   String?          @unique
  name      String
  category  String?
  cost      Decimal          @db.Decimal(12, 2) @default(0)
  price     Decimal          @db.Decimal(12, 2) @default(0)
  taxRate   Decimal          @db.Decimal(5, 2)  @default(0)
  minStock  Int              @default(0)
  active    Boolean          @default(true)
  createdAt DateTime         @default(now())
  
  SaleItem  SaleItem[]
  StockMove StockMovement[]  
  ReservationItem ReservationItem[]

  @@index([sku])
  @@index([name])
  @@index([category])
}

model Sale {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id]) // âœ… NUEVO
  storeId   Int?
  customer  String?
  subtotal  Decimal  @db.Decimal(12, 2) @default(0)
  tax       Decimal  @db.Decimal(12, 2) @default(0)
  discount  Decimal  @db.Decimal(12, 2) @default(0)
  total     Decimal  @db.Decimal(12, 2) @default(0)
  status    String   @default("paid")
  createdAt DateTime @default(now())
  items     SaleItem[]
  payments  Payment[]
  reservations Reservation[]
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  sale      Sale    @relation(fields: [saleId], references: [id])
  saleId    Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  qty       Int
  unitPrice Decimal @db.Decimal(12, 2) @default(0)
  taxRate   Decimal @db.Decimal(5, 2)  @default(0)
  discount  Decimal @db.Decimal(12, 2) @default(0)
  total     Decimal @db.Decimal(12, 2) @default(0)
}

model Payment {
  id        Int      @id @default(autoincrement())
  sale      Sale     @relation(fields: [saleId], references: [id])
  saleId    Int
  method    String   // EFECTIVO | QR_LLAVE | DATAFONO
  amount    Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  createdAt DateTime @default(now())
}

model StockMovement {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  type      String   // in|out|adj|return
  qty       Int
  unitCost  Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  userId    Int?
  storeId   Int?
  createdAt DateTime @default(now())

  @@index([productId, createdAt])
  @@index([type])
}

model Expense {
  id            Int      @id @default(autoincrement())
  storeId       Int?
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id]) // âœ… NUEVO
  category      String
  description   String?
  amount        Decimal  @db.Decimal(12, 2) @default(0)
  paymentMethod String?
  createdAt     DateTime @default(now())

  @@index([createdAt])
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      Role     @default(EMPLOYEE)
  createdAt DateTime @default(now())

  sales     Sale[]    // âœ… NUEVO (inversa)
  expenses  Expense[] // âœ… NUEVO (inversa)
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum WorkStatus {
  RECEIVED     // Recibido
  IN_PROGRESS  // En proceso
  FINISHED     // Finalizado (listo para entrega)
  DELIVERED    // Entregado
}

enum WorkLocation {
  LOCAL
  BOGOTA
}

model WorkOrder {
  id            Int           @id @default(autoincrement())
  code          String                               // WK-00001
  item          String                               // quÃ© se recibe
  description   String                               // descripciÃ³n del caso
  customerName  String
  customerPhone String
  reviewPaid    Boolean       @default(false)        // pagÃ³ $20.000 revisiÃ³n
  status        WorkStatus    @default(RECEIVED)
  location      WorkLocation  @default(LOCAL)
  quote         Decimal?      @db.Decimal(12, 2)     // cotizaciÃ³n (opcional)
  deposit       Decimal?      @db.Decimal(12, 2)     // acumulado de abonos (si decides mantenerlo)
  total         Decimal?      @db.Decimal(12, 2)     // total final (opcional)
  notes         String?                             // notas internas
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  payments      WorkOrderPayment[]                   // ðŸ‘ˆ inversa para pagos
  informedCustomer Boolean @default(false)

  isWarranty    Boolean   @default(false)
  parentId      Int?      // id del trabajo original (trazabilidad simple)

  items         WorkItem[]

  @@index([status, location, createdAt])
  @@index([code])
}

model WorkItem {
  id          Int        @id @default(autoincrement())
  workOrder   WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId Int

  label       String
  done        Boolean    @default(false)

  price       Decimal?   @db.Decimal(12, 2)   // valor del arreglo de ESTE producto
  detail      String?                          // descripciÃ³n especÃ­fica del producto

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([workOrderId])
}

model WorkOrderPayment {
  id          Int        @id @default(autoincrement())
  workOrder   WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId Int
  amount      Decimal    @db.Decimal(12, 2)         // > 0 pago del cliente (abono o liquidaciÃ³n)
  method      String?                                // CASH/CARD/NEQUI/etc
  note        String?
  createdAt   DateTime   @default(now())
  createdBy   String?                                // usuario que registrÃ³

  @@index([workOrderId, createdAt])
}

enum ReservationStatus {
  OPEN        // equivalente a LayawayStatus.OPEN
  CLOSED      // equivalente a LayawayStatus.CLOSED (pagado/completado)
  CANCELLED   // nuevo (por si cancelas apartados)
}

enum ReservationKind {
  APARTADO
  ENCARGO
}

model Reservation {
  id        Int               @id @default(autoincrement())
  code      String            @unique
  status    ReservationStatus @default(OPEN)

  kind      ReservationKind   @default(APARTADO) // âœ… NUEVO
  pickupDate DateTime?        // âœ… NUEVO (solo ENCARGO)
  convertedFromEncargo Boolean @default(false) // âœ… NUEVO
  kindChangedAt DateTime?     // âœ… NUEVO (auditorÃ­a)

  customerName  String
  customerPhone String
  customerDoc   String?
  city          String?

  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  closedAt   DateTime?

  subtotal   Decimal    @db.Decimal(12, 2) @default(0)
  discount   Decimal    @db.Decimal(12, 2) @default(0)
  totalPrice Decimal    @db.Decimal(12, 2) @default(0)
  totalPaid  Decimal    @db.Decimal(12, 2) @default(0)

  items     ReservationItem[]
  payments  ReservationPayment[]

  saleId    Int?
  sale      Sale?      @relation(fields: [saleId], references: [id])

  @@index([kind, status, createdAt])  // âœ… Ãºtil para columnas
  @@index([pickupDate])              // âœ… Ãºtil para vencidos
  @@index([status, createdAt])
  @@index([customerPhone])
  @@index([code])
}


model ReservationItem {
  id            Int          @id @default(autoincrement())
  reservation   Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  reservationId Int

  // Producto (opcional pero recomendado para stock y trazabilidad)
  product   Product? @relation(fields: [productId], references: [id])
  productId Int?

  // Snapshot al momento del apartado
  productName   String
  skuSnapshot   String?
  unitPrice     Decimal   @db.Decimal(12, 2) @default(0)
  qty           Int       @default(1)

  discount      Decimal   @db.Decimal(12, 2) @default(0)  // descuento por lÃ­nea (opcional)
  totalLine     Decimal   @db.Decimal(12, 2) @default(0)  // (unitPrice*qty) - discount

  createdAt     DateTime  @default(now())

  @@index([reservationId])
  @@index([productId])
}

model ReservationPayment {
  id            Int          @id @default(autoincrement())
  reservation   Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  reservationId Int

  amount     Decimal  @db.Decimal(12, 2) @default(0)
  method     String   // EFECTIVO | QR_LLAVE | DATAFONO  (igual que LayawayPayment)
  reference  String?
  note       String?
  createdAt  DateTime @default(now())
  createdBy  String?

  @@index([reservationId, createdAt])
  @@index([method])
}
