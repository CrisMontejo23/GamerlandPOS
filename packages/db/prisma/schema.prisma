generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // si alguna vez usas pooling (pgbouncer) en DATABASE_URL, Prisma migrar谩 por DIRECT_URL
  directUrl = env("DIRECT_URL") // opcional
}

model Product {
  id        Int              @id @default(autoincrement())
  sku       String           @unique
  barcode   String?          @unique
  name      String
  category  String?
  cost      Decimal          @db.Decimal(12, 2) @default(0)
  price     Decimal          @db.Decimal(12, 2) @default(0)
  taxRate   Decimal          @db.Decimal(5, 2)  @default(0)
  minStock  Int              @default(0)
  active    Boolean          @default(true)
  createdAt DateTime         @default(now())
  SaleItem  SaleItem[]
  StockMove StockMovement[]

  @@index([sku])
  @@index([name])
  @@index([category])
}

model Sale {
  id        Int        @id @default(autoincrement())
  userId    Int?
  storeId   Int?
  customer  String?
  subtotal  Decimal    @db.Decimal(12, 2) @default(0)
  tax       Decimal    @db.Decimal(12, 2) @default(0)
  discount  Decimal    @db.Decimal(12, 2) @default(0)
  total     Decimal    @db.Decimal(12, 2) @default(0)
  status    String     @default("paid") // paid|void|return
  createdAt DateTime   @default(now())
  items     SaleItem[]
  payments  Payment[]
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  sale      Sale    @relation(fields: [saleId], references: [id])
  saleId    Int
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  qty       Int
  unitPrice Decimal @db.Decimal(12, 2) @default(0)
  taxRate   Decimal @db.Decimal(5, 2)  @default(0)
  discount  Decimal @db.Decimal(12, 2) @default(0)
  total     Decimal @db.Decimal(12, 2) @default(0)
}

model Payment {
  id        Int      @id @default(autoincrement())
  sale      Sale     @relation(fields: [saleId], references: [id])
  saleId    Int
  method    String   // EFECTIVO | QR_LLAVE | DATAFONO
  amount    Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  createdAt DateTime @default(now())
}

model StockMovement {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  type      String   // in|out|adj|return
  qty       Int
  unitCost  Decimal  @db.Decimal(12, 2) @default(0)
  reference String?
  userId    Int?
  storeId   Int?
  createdAt DateTime @default(now())

  @@index([productId, createdAt])
  @@index([type])
}

model Expense {
  id            Int      @id @default(autoincrement())
  storeId       Int?
  userId        Int?
  category      String
  description   String?
  amount        Decimal  @db.Decimal(12, 2) @default(0)
  paymentMethod String?  // EFECTIVO | QR_LLAVE | DATAFONO
  createdAt     DateTime @default(now())

  @@index([createdAt])
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      Role     @default(EMPLOYEE)
  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum WorkStatus {
  RECEIVED     // Recibido
  IN_PROGRESS  // En proceso
  FINISHED     // Finalizado (listo para entrega)
  DELIVERED    // Entregado
}

enum WorkLocation {
  LOCAL
  BOGOTA
}

model WorkOrder {
  id            Int           @id @default(autoincrement())
  code          String        @unique                // WK-00001
  item          String                               // qu茅 se recibe
  description   String                               // descripci贸n del caso
  customerName  String
  customerPhone String
  reviewPaid    Boolean       @default(false)        // pag贸 $20.000 revisi贸n
  status        WorkStatus    @default(RECEIVED)
  location      WorkLocation  @default(LOCAL)
  quote         Decimal?      @db.Decimal(12, 2)     // cotizaci贸n (opcional)
  deposit       Decimal?      @db.Decimal(12, 2)     // acumulado de abonos (si decides mantenerlo)
  total         Decimal?      @db.Decimal(12, 2)     // total final (opcional)
  notes         String?                             // notas internas
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  payments      WorkOrderPayment[]                   //  inversa para pagos

  @@index([status, location, createdAt])
  @@index([code])
}

model WorkOrderPayment {
  id          Int        @id @default(autoincrement())
  workOrder   WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId Int
  amount      Decimal    @db.Decimal(12, 2)         // > 0 pago del cliente (abono o liquidaci贸n)
  method      String?                                // CASH/CARD/NEQUI/etc
  note        String?
  createdAt   DateTime   @default(now())
  createdBy   String?                                // usuario que registr贸

  @@index([workOrderId, createdAt])
}